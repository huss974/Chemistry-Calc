<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chemistry Calculator</title>
    <script src="https://3dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <script src="https://www.chemdoodle.com/assets/javascripts/ChemDoodleWeb.js"></script>
    <link rel="stylesheet" href="https://www.chemdoodle.com/assets/stylesheets/ChemDoodleWeb.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #2c3e50;
        }
        h1 {
            text-align: center;
            color: #2980b9;
        }
        #visualization, #lewis {
            margin: 20px auto;
            width: 100%;
            max-width: 500px;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        pre {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            font-size: 16px;
            overflow: auto;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 10px;
            font-size: 14px;
            color: #555;
            border-top: 1px solid #ddd;
        }
        footer a {
            color: #2980b9;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>Advanced Chemistry Calculator</h1>
    <p>Enter the chemical formula (e.g., H2O, C6H12O6) and the number of moles:</p>
    <form onsubmit="event.preventDefault(); calculate();">
        <label for="formula">Chemical Formula:</label>
        <input type="text" id="formula" required><br><br>

        <label for="moles">Number of Moles:</label>
        <input type="number" id="moles" step="any" required><br><br>

        <button type="submit">Calculate</button>
    </form>
    <pre id="result"></pre>

    <h2>Molecular Visualization (3D)</h2>
    <div id="visualization">3D Molecular Geometry will appear here.</div>

    <h2>Lewis Dot Structure (2D)</h2>
    <canvas id="lewis"></canvas>

    <footer>
        This calculator was created by <a href="#" target="_blank">Alsalehindustries</a>. All rights reserved.
    </footer>

    <script>
        const periodicTable = {
            H: { atomicMass: 1.008 }, He: { atomicMass: 4.0026 },
            Li: { atomicMass: 6.94 }, Be: { atomicMass: 9.0122 }, B: { atomicMass: 10.81 },
            C: { atomicMass: 12.011 }, N: { atomicMass: 14.007 }, O: { atomicMass: 15.999 },
            F: { atomicMass: 18.998 }, Ne: { atomicMass: 20.180 }, Na: { atomicMass: 22.990 },
            Mg: { atomicMass: 24.305 }, Al: { atomicMass: 26.982 }, Si: { atomicMass: 28.085 },
            P: { atomicMass: 30.974 }, S: { atomicMass: 32.06 }, Cl: { atomicMass: 35.45 },
            Ar: { atomicMass: 39.948 }, K: { atomicMass: 39.098 }, Ca: { atomicMass: 40.078 },
            // Add all elements up to Og
            Sc: { atomicMass: 44.956 }, Ti: { atomicMass: 47.867 }, V: { atomicMass: 50.942 },
            Cr: { atomicMass: 51.996 }, Mn: { atomicMass: 54.938 }, Fe: { atomicMass: 55.845 },
            Co: { atomicMass: 58.933 }, Ni: { atomicMass: 58.693 }, Cu: { atomicMass: 63.546 },
            Zn: { atomicMass: 65.38 }, Ga: { atomicMass: 69.723 }, Ge: { atomicMass: 72.63 },
            // Complete all remaining elements...
        };

        const AVOGADRO_NUMBER = 6.022e23;

        function parseFormula(formula) {
            const stack = [];
            const elementCounts = {};
            let currentElement = '';
            let currentCount = '';

            for (let i = 0; i < formula.length; i++) {
                const char = formula[i];

                if (char.match(/[A-Z]/)) {
                    // Save previous element and count
                    if (currentElement) {
                        elementCounts[currentElement] = (elementCounts[currentElement] || 0) + parseInt(currentCount || '1', 10);
                    }
                    // Start a new element
                    currentElement = char;
                    currentCount = '';
                } else if (char.match(/[a-z]/)) {
                    currentElement += char;
                } else if (char.match(/\d/)) {
                    currentCount += char;
                } else if (char === '(') {
                    // Push current counts onto stack
                    stack.push({ elementCounts: { ...elementCounts }, multiplier: parseInt(currentCount || '1', 10) });
                    currentElement = '';
                    currentCount = '';
                } else if (char === ')') {
                    // Apply multiplier to current level
                    if (currentElement) {
                        elementCounts[currentElement] = (elementCounts[currentElement] || 0) + parseInt(currentCount || '1', 10);
                        currentElement = '';
                        currentCount = '';
                    }

                    const top = stack.pop();
                    const multiplier = parseInt(formula[i + 1] || '1', 10);
                    for (const [el, count] of Object.entries(elementCounts)) {
                        top.elementCounts[el] = (top.elementCounts[el] || 0) + count * multiplier;
                    }
                    elementCounts = top.elementCounts;
                    i++; // Skip the multiplier digit
                }
            }

            // Add the last element
            if (currentElement) {
                elementCounts[currentElement] = (elementCounts[currentElement] || 0) + parseInt(currentCount || '1', 10);
            }

            return elementCounts;
        }

        function calculateMolarMass(elements) {
            return Object.entries(elements).reduce((total, [element, count]) => {
                if (!periodicTable[element]) {
                    throw new Error(`Unknown element: ${element}`);
                }
                return total + periodicTable[element].atomicMass * count;
            }, 0);
        }

        function render3DGeometry(formula) {
            const viewer = $3Dmol.createViewer("visualization", { defaultcolors: $3Dmol.elementColors.rasmol });
            viewer.addModel(formula, "smiles");
            viewer.setStyle({}, { stick: {} });
            viewer.zoomTo();
            viewer.render();
        }

        function renderLewisStructure(formula) {
            const lewisCanvas = document.getElementById("lewis");
            const sketcher = new ChemDoodle.SketcherCanvas(lewisCanvas, 500, 400);
            sketcher.loadMolecule(ChemDoodle.readSMILES(formula));
        }

        function calculate() {
            const formula = document.getElementById("formula").value.trim();
            const molesInput = parseFloat(document.getElementById("moles").value);

            if (isNaN(molesInput) || molesInput <= 0) {
                document.getElementById("result").textContent = "Please enter a valid number of moles.";
                return;
            }

            try {
                const elements = parseFormula(formula);
                const molarMass = calculateMolarMass(elements);
                const mass = molarMass * molesInput;
                const atomCount = molesInput * AVOGADRO_NUMBER;

                let result = `Molar mass of ${formula}: ${molarMass.toFixed(3)} g/mol\n`;
                result += `Number of moles: ${molesInput.toFixed(3)} mol\n`;
                result += `Mass: ${mass.toFixed(3)} g\n`;
                result += `Number of atoms/molecules: ${(atomCount).toExponential(3)}\n`;

                document.getElementById("result").textContent = result;

                render3DGeometry(formula);
                renderLewisStructure(formula);
            } catch (error) {
                document.getElementById("result").textContent = error.message;
            }
        }
    </script>
</body>
</html>
